name: Passive GitHub Reconnaissance

on:
  schedule:
    - cron: '0 3 * * 1' # Weekly on Monday at 03:00 UTC
  workflow_dispatch:
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  issues: write

concurrency:
  group: passive-recon-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --summary --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" || echo "License check completed with warnings"

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present || echo "No lint script found"
        continue-on-error: true

  repository-metrics:
    name: Repository Health Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze repository structure
        run: |
          echo "## Repository Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Total files: $(git ls-files | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript/TypeScript files: $(git ls-files | grep -E '\.(js|ts|jsx|tsx)$' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration files: $(git ls-files | grep -E '\.(json|yml|yaml|config\.js)$' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Activity" >> $GITHUB_STEP_SUMMARY
          echo "- Last 10 commits:" >> $GITHUB_STEP_SUMMARY
          git log --oneline -10 >> $GITHUB_STEP_SUMMARY

      - name: Check for security files
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Posture" >> $GITHUB_STEP_SUMMARY
          for file in SECURITY.md CODE_OF_CONDUCT.md CONTRIBUTING.md LICENSE; do
            if [ -f "$file" ]; then
              echo "- ✅ $file present" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $file missing" >> $GITHUB_STEP_SUMMARY
            fi
          done

  outdated-dependencies:
    name: Outdated Dependencies Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for outdated packages
        run: |
          npm outdated || true
          echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "Found outdated packages. Review recommended." >> $GITHUB_STEP_SUMMARY
          else
            echo "All dependencies are up to date! ✅" >> $GITHUB_STEP_SUMMARY
          fi
